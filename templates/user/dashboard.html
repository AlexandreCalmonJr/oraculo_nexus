{% extends "user/base_user.html" %}

{% block title %}Meu Dashboard - Service Desk{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    {% if active_event %}
    <div class="mb-4 bg-gradient-to-r from-red-500 to-red-700 text-white p-4 rounded-xl shadow-lg">
        <h2 class="text-lg font-bold text-center animate-pulse">
            <i class="fas fa-skull-crossbones"></i> INVAS√ÉO GLOBAL ATIVA! <i class="fas fa-skull-crossbones"></i>
        </h2>
        <h3 class="text-base font-semibold text-center mt-1">{{ active_event.name }}</h3>
        <p class="mt-2 text-center text-xs">{{ active_event.description }}</p>

        <div class="mt-3">
            <div class="flex justify-between mb-1 text-xs">
                <span>Vida do Boss</span>
                <span>{{ "{:,.0f}".format(active_event.current_hp) }} / {{
                    "{:,.0f}".format(active_event.total_hp) }} HP</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 dark:bg-gray-900/50">
                <div class="bg-yellow-400 h-3 rounded-full" style="width: {{ 100 - event_progress }}%"></div>
            </div>
            <p class="text-xs text-center mt-1">Termina em: {{ active_event.end_date.strftime('%d/%m/%Y √†s %H:%M') }}
            </p>
        </div>
    </div>
    {% endif %}

    {% if active_hunt %}
    <div class="mb-4 bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-4 rounded-xl shadow-lg">
        <h2 class="text-lg font-bold text-center">üåü {{ active_hunt.name }} üåü</h2>
        <p class="mt-2 text-center text-xs">{{ active_hunt.description }}</p>

        {% if hunt_progress and not hunt_progress.completed_at %}
        {% set current_step = active_hunt.steps.filter_by(step_number=hunt_progress.current_step).first() %}
        <div class="mt-3 bg-white/20 p-3 rounded-lg">
            <p class="font-semibold text-sm">Pista (Passo {{ hunt_progress.current_step }}):</p>
            <p class="text-xs italic mt-1">"{{ current_step.clue_text }}"</p>
        </div>
        {% elif hunt_progress and hunt_progress.completed_at %}
        <p class="mt-3 text-center font-bold text-green-300 text-sm">Voc√™ completou este evento!</p>
        {% else %}
        <div class="mt-3 text-center">
            <form method="POST" action="{{ url_for('start_hunt', hunt_id=active_hunt.id) }}">
                <button type="submit"
                    class="px-4 py-2 bg-white text-gray-900 font-bold rounded-lg hover:bg-gray-200 transition text-sm">
                    Come√ßar a Ca√ßa!
                </button>
            </form>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Layout Principal com Grid Responsivo -->
    <div class="dashboard-grid">

        <!-- Sidebar de Perfil e Cards -->
        <aside class="dashboard-sidebar">
            <!-- Card de Perfil -->
            <div class="profile-card">
                {% if current_user.avatar_url %}
                <img src="{{ current_user.avatar_url }}" alt="Avatar" class="profile-avatar">
                {% else %}
                <div class="profile-avatar-fallback">
                    {{ current_user.name[0]|upper }}
                </div>
                {% endif %}
                <h2 class="profile-name">{{ current_user.name }}</h2>
                <p class="profile-welcome">Bem-vindo(a) de volta!</p>
            </div>

            <!-- Card de Progresso -->
            <div class="progress-card">
                <h3 class="card-title">Meu Progresso</h3>
                <div class="progress-info">
                    <span class="progress-level">{{ current_user.level.name if current_user.level else 'Iniciante'
                        }}</span>
                    <span class="progress-points">{{ current_user.points }} pts</span>
                </div>
                {% if progress %}
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" style="width: {{ progress.percentage }}%"></div>
                </div>
                <div class="progress-next">
                    {% if progress.next_level_points %}
                    Pr√≥ximo n√≠vel em {{ progress.next_level_points - current_user.points }} pontos
                    {% else %}
                    N√≠vel M√°ximo!
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Desafio do Dia -->
            {% if daily_challenge %}
            <div class="daily-challenge-card">
                <h2 class="daily-title">üî• Desafio do Dia! üî•</h2>
                <p class="daily-subtitle">Ganhe <strong>{{ daily_challenge.bonus_points }} pontos</strong>!</p>
                <div class="daily-content">
                    <p class="daily-challenge-title">{{ daily_challenge.challenge.title }}</p>
                    <p class="daily-description">{{ daily_challenge.challenge.description }}</p>
                </div>
                <div class="daily-action">
                    <a href="{{ url_for('list_challenges') }}" class="daily-button">
                        Ver Desafios
                    </a>
                </div>
            </div>
            {% endif %}
        </aside>

        <!-- √Årea do Chat -->
        <main class="chat-area">
            {% include 'chat/chat.html' %}
        </main>
    </div>
</div>

<style>
    /* Container Principal */
    .dashboard-wrapper {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    /* Grid do Dashboard */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 1.5rem;
        flex: 1;
        min-height: 0;
        overflow: hidden;
    }

    /* Sidebar de Perfil */
    .dashboard-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 0.5rem;
    }

    /* Card de Perfil */
    .profile-card {
        background: var(--bg-secondary);
        backdrop-filter: blur(12px);
        padding: 1.5rem;
        border-radius: 1rem;
        border: var(--glass-border);
        box-shadow: var(--glass-shadow);
        text-align: center;
    }

    .profile-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 1rem;
        border: 3px solid var(--primary-500);
    }

    .profile-avatar-fallback {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin: 0 auto 1rem;
        background: linear-gradient(135deg, var(--primary-500), var(--secondary-500));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-on-primary);
        box-shadow: var(--neon-shadow);
    }

    .profile-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0 0 0.25rem 0;
    }

    .profile-welcome {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0;
    }

    /* Card de Progresso */
    .progress-card {
        background: var(--bg-secondary);
        backdrop-filter: blur(12px);
        padding: 1.25rem;
        border-radius: 1rem;
        border: var(--glass-border);
        box-shadow: var(--glass-shadow);
    }

    .card-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 1rem 0;
    }

    .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        font-size: 0.875rem;
    }

    .progress-level {
        color: var(--text-secondary);
    }

    .progress-points {
        color: var(--primary-500);
        font-weight: 600;
    }

    .progress-bar-container {
        width: 100%;
        height: 8px;
        background: var(--bg-tertiary);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary-500), var(--secondary-500));
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .progress-next {
        font-size: 0.75rem;
        color: var(--text-secondary);
        text-align: right;
    }

    /* Desafio do Dia */
    .daily-challenge-card {
        background: linear-gradient(135deg, #f59e0b, #f97316);
        padding: 1.25rem;
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        color: white;
    }

    .daily-title {
        font-size: 1rem;
        font-weight: 700;
        text-align: center;
        margin: 0 0 0.5rem 0;
    }

    .daily-subtitle {
        font-size: 0.75rem;
        text-align: center;
        margin: 0 0 1rem 0;
        opacity: 0.95;
    }

    .daily-content {
        background: rgba(255, 255, 255, 0.15);
        padding: 0.875rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }

    .daily-challenge-title {
        font-size: 0.875rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
    }

    .daily-description {
        font-size: 0.75rem;
        margin: 0;
        opacity: 0.9;
        line-height: 1.4;
    }

    .daily-action {
        text-align: center;
    }

    .daily-button {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        background: white;
        color: #1f2937;
        font-weight: 600;
        font-size: 0.875rem;
        border-radius: 0.5rem;
        text-decoration: none;
        transition: all 0.3s ease;
    }

    .daily-button:hover {
        background: #f3f4f6;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* √Årea do Chat */
    .chat-area {
        min-height: 0;
        display: flex;
        flex-direction: column;
    }

    .chat-area .chat-container-modern {
        height: 100% !important;
        flex: 1;
    }

    /* Scrollbar da Sidebar */
    .dashboard-sidebar::-webkit-scrollbar {
        width: 6px;
    }

    .dashboard-sidebar::-webkit-scrollbar-track {
        background: transparent;
    }

    .dashboard-sidebar::-webkit-scrollbar-thumb {
        background: var(--scrollbar-thumb);
        border-radius: 3px;
    }

    .dashboard-sidebar::-webkit-scrollbar-thumb:hover {
        background: var(--scrollbar-thumb-hover);
    }

    /* Responsividade */
    @media (max-width: 1024px) {
        .dashboard-grid {
            grid-template-columns: 280px 1fr;
            gap: 1rem;
        }
    }

    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .dashboard-sidebar {
            max-height: 400px;
        }

        .chat-area {
            min-height: 500px;
        }
    }

    @media (max-width: 480px) {
        .dashboard-wrapper {
            gap: 0.75rem;
        }

        .profile-avatar,
        .profile-avatar-fallback {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        .profile-name {
            font-size: 1.125rem;
        }

        .card-title {
            font-size: 0.875rem;
        }
    }
</style>
{% endblock %}