{% extends 'admin/admin_base.html' %}

{% block title %}Dashboard Administrativo{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block head_extra %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<!-- Estatísticas Principais -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Card: Usuários -->
    <div class="stat-card">
        <div class="stat-icon bg-blue-500">
            <i class="fas fa-users fa-2x"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Total de Usuários</p>
            <p class="stat-value" id="total-users">{{ stats.total_users }}</p>
            <p class="stat-change text-green-500"><i class="fas fa-arrow-up"></i> <span id="new-users-today">0</span>
                hoje</p>
        </div>
    </div>

    <!-- Card: Desafios -->
    <div class="stat-card">
        <div class="stat-icon bg-purple-500">
            <i class="fas fa-gamepad fa-2x"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Desafios Completados</p>
            <p class="stat-value">{{ stats.total_challenges_completed }}</p>
            <p class="stat-change text-blue-500"><i class="fas fa-trophy"></i> <span id="challenges-today">0</span> hoje
            </p>
        </div>
    </div>

    <!-- Card: Times -->
    <div class="stat-card">
        <div class="stat-icon bg-green-500">
            <i class="fas fa-user-friends fa-2x"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">Times Ativos</p>
            <p class="stat-value">{{ stats.total_teams }}</p>
            <p class="stat-change text-green-500"><i class="fas fa-check"></i> Ativos</p>
        </div>
    </div>

    <!-- Card: FAQs -->
    <div class="stat-card">
        <div class="stat-icon bg-yellow-500">
            <i class="fas fa-question-circle fa-2x"></i>
        </div>
        <div class="stat-content">
            <p class="stat-label">FAQs Cadastradas</p>
            <p class="stat-value">{{ stats.total_faqs }}</p>
            <p class="stat-change text-gray-500"><i class="fas fa-book"></i> Base</p>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Gráfico 1: Usuários Ativos (Linha) -->
    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-chart-line mr-2"></i>
            Novos Usuários (Últimos 30 Dias)
        </h3>
        <canvas id="usersChart"></canvas>
    </div>

    <!-- Gráfico 2: Desafios Completados (Barra) -->
    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-chart-bar mr-2"></i>
            Desafios Completados (Última Semana)
        </h3>
        <canvas id="challengesChart"></canvas>
    </div>

    <!-- Gráfico 3: Distribuição de Níveis (Pizza) -->
    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-chart-pie mr-2"></i>
            Distribuição de Níveis
        </h3>
        <canvas id="levelsChart"></canvas>
    </div>

    <!-- Gráfico 4: Engajamento por Trilha (Barra Horizontal) -->
    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-route mr-2"></i>
            Top 10 Trilhas Mais Populares
        </h3>
        <canvas id="pathsChart"></canvas>
    </div>

    <!-- Gráfico 5: Taxa de Conclusão (Área) -->
    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-chart-area mr-2"></i>
            Taxa de Conclusão (Última Semana)
        </h3>
        <canvas id="completionChart"></canvas>
    </div>

    <!-- Gráfico 6: Atividade por Hora (Barra) -->
    <div class="chart-card">
        <h3 class="chart-title">
            <i class="fas fa-clock mr-2"></i>
            Atividade por Hora do Dia
        </h3>
        <canvas id="hourlyChart"></canvas>
    </div>
</div>

<!-- Ações Rápidas (mantido do dashboard anterior) -->
<div class="admin-card">
    <h3 class="card-title">
        <i class="fas fa-bolt mr-2"></i>
        Ações Rápidas
    </h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <a href="{{ url_for('admin_users') }}" class="quick-action">
            <i class="fas fa-user-plus text-2xl mb-2 text-blue-500"></i>
            <span>Novo Usuário</span>
        </a>

        <a href="{{ url_for('admin_challenges') }}" class="quick-action">
            <i class="fas fa-gamepad text-2xl mb-2 text-purple-500"></i>
            <span>Novo Desafio</span>
        </a>

        <a href="{{ url_for('admin_faq') }}" class="quick-action">
            <i class="fas fa-question-circle text-2xl mb-2 text-green-500"></i>
            <span>Nova FAQ</span>
        </a>

        <a href="{{ url_for('admin_import_content') }}" class="quick-action">
            <i class="fas fa-file-import text-2xl mb-2 text-yellow-500"></i>
            <span>Importar</span>
        </a>
    </div>
</div>

<style>
    /* Cards de Estatísticas (mantido) */
    .stat-card {
        background: var(--bg-secondary);
        backdrop-filter: blur(12px);
        padding: 1.5rem;
        border-radius: 1rem;
        border: var(--glass-border);
        box-shadow: var(--glass-shadow);
        display: flex;
        align-items: center;
        gap: 1rem;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        flex-shrink: 0;
    }

    .stat-content {
        flex: 1;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0 0 0.25rem 0;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
        line-height: 1;
    }

    .stat-change {
        font-size: 0.75rem;
        margin: 0.5rem 0 0 0;
        font-weight: 600;
    }

    /* Cards de Gráficos */
    .chart-card {
        background: var(--bg-secondary);
        backdrop-filter: blur(12px);
        padding: 1.5rem;
        border-radius: 1rem;
        border: var(--glass-border);
        box-shadow: var(--glass-shadow);
    }

    .chart-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 1.5rem 0;
        display: flex;
        align-items: center;
    }

    /* Cards Admin (mantido) */
    .admin-card {
        background: var(--bg-secondary);
        backdrop-filter: blur(12px);
        padding: 1.5rem;
        border-radius: 1rem;
        border: var(--glass-border);
        box-shadow: var(--glass-shadow);
    }

    .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 1.5rem 0;
        display: flex;
        align-items: center;
    }

    /* Ações Rápidas (mantido) */
    .quick-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        border-radius: 0.75rem;
        background: var(--bg-tertiary);
        text-decoration: none;
        color: var(--text-primary);
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-align: center;
    }

    .quick-action:hover {
        background: var(--bg-secondary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    /* Responsividade */
    @media (max-width: 768px) {
        .stat-card {
            flex-direction: column;
            text-align: center;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
        }

        .stat-value {
            font-size: 1.75rem;
        }
    }
</style>

<script>
    // Configuração global do Chart.js
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
    Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--glass-border');

    // Cores do tema
    const colors = {
        primary: '#3b82f6',
        secondary: '#8b5cf6',
        success: '#22c55e',
        warning: '#f59e0b',
        danger: '#ef4444',
        info: '#06b6d4'
    };

    // Carregar dados da API
    async function loadChartData() {
        try {
            const response = await fetch('/admin/api/stats');
            const data = await response.json();

            // Atualizar cards
            const summaryResponse = await fetch('/admin/api/stats/summary');
            const summary = await summaryResponse.json();
            document.getElementById('new-users-today').textContent = summary.new_users_today;
            document.getElementById('challenges-today').textContent = summary.challenges_today;

            // Criar gráficos
            createUsersChart(data.users_timeline);
            createChallengesChart(data.challenges_daily);
            createLevelsChart(data.levels_distribution);
            createPathsChart(data.paths_engagement);
            createCompletionChart(data.completion_rate);
            createHourlyChart(data.hourly_activity);

        } catch (error) {
            console.error('Erro ao carregar dados dos gráficos:', error);
        }
    }

    // Gráfico 1: Usuários Ativos (Linha)
    function createUsersChart(data) {
        new Chart(document.getElementById('usersChart'), {
            type: 'line',
            data: {
                labels: data.map(d => d.date),
                datasets: [{
                    label: 'Novos Usuários',
                    data: data.map(d => d.count),
                    borderColor: colors.primary,
                    backgroundColor: colors.primary + '20',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Gráfico 2: Desafios Completados (Barra)
    function createChallengesChart(data) {
        new Chart(document.getElementById('challengesChart'), {
            type: 'bar',
            data: {
                labels: data.map(d => d.day),
                datasets: [{
                    label: 'Desafios',
                    data: data.map(d => d.count),
                    backgroundColor: colors.secondary
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Gráfico 3: Distribuição de Níveis (Pizza)
    function createLevelsChart(data) {
        new Chart(document.getElementById('levelsChart'), {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.level),
                datasets: [{
                    data: data.map(d => d.count),
                    backgroundColor: [
                        colors.primary,
                        colors.secondary,
                        colors.success,
                        colors.warning,
                        colors.danger,
                        colors.info
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true
            }
        });
    }

    // Gráfico 4: Engajamento por Trilha (Barra Horizontal)
    function createPathsChart(data) {
        new Chart(document.getElementById('pathsChart'), {
            type: 'bar',
            data: {
                labels: data.map(d => d.path),
                datasets: [{
                    label: 'Usuários',
                    data: data.map(d => d.users),
                    backgroundColor: colors.success
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Gráfico 5: Taxa de Conclusão (Área)
    function createCompletionChart(data) {
        new Chart(document.getElementById('completionChart'), {
            type: 'line',
            data: {
                labels: data.map(d => d.day),
                datasets: [{
                    label: 'Taxa (%)',
                    data: data.map(d => d.rate),
                    borderColor: colors.success,
                    backgroundColor: colors.success + '20',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: value => value + '%'
                        }
                    }
                }
            }
        });
    }

    // Gráfico 6: Atividade por Hora (Barra)
    function createHourlyChart(data) {
        new Chart(document.getElementById('hourlyChart'), {
            type: 'bar',
            data: {
                labels: Array.from({ length: 24 }, (_, i) => i + 'h'),
                datasets: [{
                    label: 'Atividades',
                    data: data,
                    backgroundColor: colors.info
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    // Carregar dados ao carregar a página
    document.addEventListener('DOMContentLoaded', loadChartData);

    // Atualizar a cada 5 minutos
    setInterval(loadChartData, 300000);
</script>
{% endblock %}