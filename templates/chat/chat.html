<!-- Import Google Fonts (Outfit & Fira Code) -->
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Fira+Code:wght@400&display=swap"
    rel="stylesheet">
<!-- Import Marked.js for Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<div class="chat-container-modern h-full flex flex-col" role="application" aria-label="Chat do Oráculo Nexus">
    <header class="chat-header-modern">
        <div class="avatar-modern bot-avatar" aria-hidden="true">
            <i class="fas fa-robot"></i>
        </div>
        <div class="chat-header-info">
            <h1 class="chat-title-modern">Oráculo Nexus</h1>
            <p class="chat-status-modern">
                <span class="status-indicator-modern" aria-hidden="true"></span>
                Online
            </p>
        </div>
    </header>

    <main class="chat-body-modern flex-1 overflow-y-auto" id="chatBox" role="log" aria-live="polite"
        aria-label="Conversa do chat">
        <!-- As mensagens do chat aparecerão aqui -->
    </main>

    <div class="typing-indicator-modern" id="typingIndicator" aria-label="Assistente está digitando">
        <div class="typing-dots-modern">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>

    <div class="chat-input-area-modern">
        <form class="chat-form-modern" id="chat-form">
            <label for="chatInput" class="sr-only">Digite sua mensagem</label>
            <textarea id="chatInput" class="chat-input-modern" rows="1" placeholder="Pergunte ao Oráculo..."
                aria-describedby="send-button-desc"></textarea>
            <button type="submit" id="sendButton" class="send-button-modern" aria-label="Enviar mensagem">
                <i class="fas fa-paper-plane" aria-hidden="true"></i>
            </button>
            <span id="send-button-desc" class="sr-only">Pressione Enter para enviar ou Shift+Enter para nova
                linha</span>
        </form>
    </div>
</div>

<style>
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }

    /* Forçar altura total do container */
    .chat-container-modern {
        height: 100% !important;
        max-height: none !important;
        min-height: 500px;
    }

    /* Garantir que o chat body use o espaço disponível */
    .chat-body-modern {
        flex: 1 1 auto;
        min-height: 0;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Prevenir inicialização duplicada
        if (window.chatScriptLoaded) {
            console.log('Chat já inicializado, pulando...');
            return;
        }
        window.chatScriptLoaded = true;

        const chatContainer = document.querySelector('.chat-container-modern');
        if (!chatContainer) {
            console.error('Container do chat não encontrado');
            return;
        }

        const chatBox = chatContainer.querySelector('#chatBox');
        const chatForm = chatContainer.querySelector('#chat-form');
        const chatInput = chatContainer.querySelector('#chatInput');
        const sendButton = chatContainer.querySelector('#sendButton');
        const typingIndicator = chatContainer.querySelector('#typingIndicator');
        const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || '';

        // Configurar Marked.js
        marked.setOptions({
            breaks: true,
            gfm: true
        });

        function showTyping(show) {
            typingIndicator.style.display = show ? 'block' : 'none';
            sendButton.disabled = show;
            chatInput.disabled = show;
            if (!show) chatInput.focus();
            scrollToBottom();
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function autoResizeTextarea() {
            chatInput.style.height = 'auto';
            chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
        }

        function addMessage(sender, message, isHtml = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('chat-message-modern', sender);

            const avatar = document.createElement('div');
            avatar.classList.add('avatar-modern', sender === 'user' ? 'user-avatar' : 'bot-avatar');
            const iconClass = sender === 'user' ? 'fa-user' : 'fa-robot';
            avatar.innerHTML = `<i class="fas ${iconClass}"></i>`;

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content-modern');

            if (sender === 'bot') {
                messageContent.innerHTML = marked.parse(message);
            } else {
                messageContent.textContent = message;
            }

            messageWrapper.appendChild(avatar);
            messageWrapper.appendChild(messageContent);
            chatBox.appendChild(messageWrapper);
            scrollToBottom();
        }

        async function sendMessageToServer(message) {
            showTyping(true);
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ mensagem: message }),
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                addMessage('bot', data.text);

            } catch (error) {
                console.error('Erro:', error);
                addMessage('bot', '⚠️ **Erro de conexão.** Não consegui contatar o servidor.');
            } finally {
                showTyping(false);
            }
        }

        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message && !sendButton.disabled) {
                addMessage('user', message);
                sendMessageToServer(message);
                chatInput.value = '';
                autoResizeTextarea();
            }
        });

        chatInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });

        chatInput.addEventListener('input', autoResizeTextarea);

        // Mensagem inicial
        if (chatBox.children.length === 0) {
            addMessage('bot', 'Olá! Sou o **Oráculo Nexus**. Como posso ajudar você hoje?');
        }

        console.log('Chat inicializado com sucesso');
    });
</script>